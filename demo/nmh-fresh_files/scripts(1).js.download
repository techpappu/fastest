
(function ($) {
    $.fn.cartWidget = function (checkout) {
        if ($('#cart-widget-side').length) {
            var amount = 0;
            $('#cart-widget-side .cart-widget-wrapper .widget-scroll-content').empty();

            // Loop through all checkout groups
            $.each(checkout, function (key, group) {
                if (Array.isArray(group)) {
                    group.forEach(item => renderCartItem(item));
                } else if (typeof group === 'object' && group !== null) {
                    $.each(group, function (_, item) {
                        renderCartItem(item);
                    });
                }
            });

            function renderCartItem(item) {
                const itemHtml = `
                <div class="mini_cart_item py-2 px-2 position-relative border-bottom">
                    <a href="#" class="remove_from_cart_button" data-id="${item.id}" data-variations="${item.variations}">&times;</a>
                    <a href="${item.slug}" rel="nofollow" class="d-flex align-items-center">
                        <img src="/upload/228/${item.thumb}" alt="${item.title}">
                        <div class="cart-info">
                            <span class="fs-3 fw-600">${item.title}</span>
                            <span class="quantity">
                                ${item.quantity} Ã—
                                <span class="cart-Price-amount amount">
                                ${$('meta[name=currency-symbol]').attr('content')}${$(document).formatNumber(item.price)}
                                </span>
                            </span>
                        </div>
                    </a>
                </div>
            `;

                amount += parseFloat(item.price) * parseInt(item.quantity);
                $('#cart-widget-side .cart-widget-wrapper .widget-scroll-content').append(itemHtml);
            }

            $('#cart-widget-side .cart-widget-wrapper .widget_mini_cart_total .amount').html(
                `${$('meta[name=currency-symbol]').attr('content')}${$(document).formatNumber(amount)}`
            );

            $('#cart-widget-side').addClass('cart-widget-opened');
        } else {
            console.warn('#cart-widget-side element does not exist.');
        }
    };



    $(document).on("click", ".remove_from_cart_button", function (e) {
        e.preventDefault();
        var id = $(this).attr('data-id');
        var variation = $(this).attr('data-variations');
        var This = $(this);
        $.ajax({
            data: {
                api: 'api',
                remove: id,
                variation: variation,
            },
            url: base_url + "checkout",
            type: "get",
            dataType: 'json',
            success: function (data) {
                $.ajax({
                    url: `${base_url}checkout?api=api`,
                    method: "GET",
                    dataType: "json",
                    success: (data) => {
                        if (data && data['checkout']) {
                            $(document).cartWidget(data['checkout']);
                        }
                    },
                    error: (error) => {
                        console.error("MiniCart AJAX error:", error);
                    },
                });
            },
            error: function (data) {
                console.error("Error removing item from cart:", data);
            }
        });
    });
})(jQuery);
