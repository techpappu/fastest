class OxioSoftCore {
    constructor(options) {
        this.typingTimer = null;
        this.doneTypingInterval = 1000;
        this.options = options;
        this.csrfToken = $('meta[name="csrf-token"]').attr('content');
    }

    init() {
        this.ajaxSetup();
        this.initConversionData();
        this.bindScrollLinks();
        this.cartOutsideClickListener();
        this.MiniCart();
        this.AddToCart();
        this.failOrders();
    }


    ajaxSetup() {
        $.ajaxSetup({
            headers: {
                "X-CSRF-TOKEN": this.csrfToken,
            },
            contentType: 'application/x-www-form-urlencoded',
        });
    }

    initConversionData() {
        if (this.options.facebook && this.options.facebook.length > 0) {
            if (!window.fbq) {
                (function (f, b, e, v, n, t, s) {
                    if (f.fbq) return;
                    n = f.fbq = function () {
                        n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments)
                    };
                    if (!f._fbq) f._fbq = n;
                    n.push = n;
                    n.loaded = true;
                    n.version = '2.0';
                    n.agent = 'oxiobd';
                    n.queue = [];
                    t = b.createElement(e); t.async = true;
                    t.src = v;
                    s = b.getElementsByTagName(e)[0];
                    s.parentNode.insertBefore(t, s);
                })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
            }
            $.each(this.options.facebook, (index, fbData) => {
                if (fbData.id) {
                    fbq('init', fbData.id);
                    fbq('set', 'autoConfig', false, fbData.id);
                }
            });
        }

        if (this.options.tiktok && this.options.tiktok.length > 0) {

            /* ==========================
             * Load TikTok base script ONCE
             * ========================== */
            if (!window.ttq) {
                (function (w, d, t) {
                    w.TiktokAnalyticsObject = t;
                    var ttq = w[t] = w[t] || [];
                    ttq.methods = [
                        "page", "track", "identify", "instances", "debug", "on", "off",
                        "once", "ready", "alias", "group", "enableCookie", "disableCookie",
                        "holdConsent", "revokeConsent", "grantConsent"
                    ];
                    ttq.setAndDefer = function (t, e) {
                        t[e] = function () {
                            t.push([e].concat([].slice.call(arguments, 0)));
                        };
                    };
                    for (var i = 0; i < ttq.methods.length; i++) {
                        ttq.setAndDefer(ttq, ttq.methods[i]);
                    }
                    ttq.instance = function (t) {
                        var e = ttq._i[t] || [];
                        for (var n = 0; n < ttq.methods.length; n++) {
                            ttq.setAndDefer(e, ttq.methods[n]);
                        }
                        return e;
                    };
                    ttq.load = function (e, n) {
                        var r = "https://analytics.tiktok.com/i18n/pixel/events.js";
                        ttq._i = ttq._i || {};
                        ttq._i[e] = [];
                        ttq._i[e]._u = r;
                        ttq._t = ttq._t || {};
                        ttq._t[e] = +new Date;
                        ttq._o = ttq._o || {};
                        ttq._o[e] = n || {};
                        var s = d.createElement("script");
                        s.type = "text/javascript";
                        s.async = true;
                        s.src = r + "?sdkid=" + e + "&lib=" + t;
                        var x = d.getElementsByTagName("script")[0];
                        x.parentNode.insertBefore(s, x);
                    };
                })(window, document, 'ttq');
            }

            /* ==========================
             * Guards
             * ========================== */
            window.__TT_LOADED__ = window.__TT_LOADED__ || {};
            window.__TT_PAGEVIEW_FIRED__ = window.__TT_PAGEVIEW_FIRED__ || {};

            /* ==========================
             * Load + PageView per pixel
             * ========================== */
            this.options.tiktok.forEach((ttData) => {
                if (!ttData.id) return;

                // load pixel once
                if (!window.__TT_LOADED__[ttData.id]) {
                    window.__TT_LOADED__[ttData.id] = true;
                    ttq.load(ttData.id);
                }

                // PageView → MUST be per instance
                if (!window.__TT_PAGEVIEW_FIRED__[ttData.id]) {
                    window.__TT_PAGEVIEW_FIRED__[ttData.id] = true;
                    ttq.instance(ttData.id).page();
                }
            });
        }


        if (this.options.google && this.options.google.length > 0) {

            window.dataLayer = window.dataLayer || [];
            this.options.google.forEach((gtmId) => {

                // prevent duplicate load per GTM
                window.__LOADED_GTM__ = window.__LOADED_GTM__ || {};
                if (window.__LOADED_GTM__[gtmId]) return;

                window.__LOADED_GTM__[gtmId] = true;

                // GTM start event
                window.dataLayer.push({
                    'gtm.start': new Date().getTime(),
                    event: 'gtm.js'
                });

                // Inject GTM
                (function (w, d, s, l, i) {
                    var f = d.getElementsByTagName(s)[0],
                        j = d.createElement(s),
                        dl = l != 'dataLayer' ? '&l=' + l : '';
                    j.async = true;
                    j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
                    f.parentNode.insertBefore(j, f);
                })(window, document, 'script', 'dataLayer', gtmId);

            });
        }

        OxioSoftCoreInstance.BrowserEventFire(this.options);

    }


    BrowserEventFire(event) {


        if (event.facebook && event.facebook.length > 0) {
            $.each(event.facebook, (index, fbData) => {

                if (fbData.id) {
                    $.each(event.Events, (eventIndex, event) => {
                        let params = { ...event };
                        if (params.event_id) delete params.event_id;
                        if (params.event_name) delete params.event_name;
                        if (params.custom_data) {
                            const customData = { ...params.custom_data };
                            delete params.custom_data;
                            params = { ...customData, ...params };
                        }

                        const fbOptions = {};
                        if (event.event_id) {
                            fbOptions.eventID = (fbData.id + '-' + event.event_id).trim();
                        }

                        if (fbData.test_id) {
                            fbOptions.test_event_code = fbData.test_id;
                        }
                        fbq('trackSingle', fbData.id, event.event_name, params, fbOptions);
                    });
                }
            });
        }

        if (event.google && Object.keys(event.google).length > 0) {
            $.each(event.Events, (eventIndex, ev) => {

                // ⚠️ FIX: comparison, not assignment
                if (ev.event_name === 'PageView') {
                    this.PageViewGoogleEventFire(ev);
                }
                else if (ev.event_name === 'ViewContent') {
                    this.ViewContentGoogleEventFire(ev);
                }
                else if (ev.event_name === 'AddToCart') {
                    this.FireGoogleAddToCart(ev);
                }
                else if (ev.event_name === 'InitiateCheckout') {
                    this.FireGoogleBeginCheckout(ev);
                }
                else if (ev.event_name === 'Purchase') {
                    this.FireGooglePurchase(ev);
                }

            });
        }
        if (event.tiktok && event.tiktok.length > 0) {
            $.each(event.Events, (eventIndex, ev) => {

                if (ev.event_name === 'ViewContent') {
                    this.FireTikTokViewContent(ev);
                }

                else if (ev.event_name === 'AddToCart') {
                    this.FireTikTokAddToCart(ev);
                }
                else if (ev.event_name === 'InitiateCheckout') {
                    this.FireTikTokInitiateCheckout(ev);
                }
                else if (ev.event_name === 'Purchase') {
                    this.FireTikTokPurchase(ev);
                }

            });
        }

        return;
    }
    FireTikTokPurchase(ev) {

        if (!window.ttq || !this.options.tiktok) return;

        const contents = (ev.custom_data?.contents || []).map(item => ({
            content_id: item.id,
            quantity: item.quantity
        }));

        this.options.tiktok.forEach(ttData => {
            if (!ttData.id) return;

            ttq.instance(ttData.id).track('Purchase', {
                value: parseFloat(ev.custom_data?.value),
                currency: ev.custom_data?.currency,

                content_ids: ev.custom_data?.content_ids,
                content_type: ev.custom_data?.content_type,
                contents: contents,

                event_id: (ttData.id + '-' + ev.event_id).trim()
            });
        });
    }


    FireTikTokAddToCart(ev) {

        if (!window.ttq || !this.options.tiktok) return;

        const contents = (ev.custom_data?.contents || []).map(item => ({
            content_id: item.id,
            quantity: item.quantity
        }));

        this.options.tiktok.forEach(ttData => {
            if (!ttData.id) return;

            ttq.instance(ttData.id).track('AddToCart', {
                value: parseFloat(ev.custom_data?.value),
                currency: ev.custom_data?.currency,

                content_ids: ev.custom_data?.content_ids,
                content_type: ev.custom_data?.content_type,
                contents: contents,

                event_id: (ttData.id + '-' + ev.event_id).trim()
            });
        });
    }
    normalizeContents(contents) {
        if (!contents) return [];

        // already array
        if (Array.isArray(contents)) {
            return contents;
        }

        // object → array
        if (typeof contents === 'object') {
            return Object.values(contents);
        }

        return [];
    }
    FireTikTokInitiateCheckout(ev) {

        if (!window.ttq || !this.options.tiktok) return;

        const rawContents = this.normalizeContents(ev.custom_data?.contents);

        const contents = rawContents.map(item => ({
            content_id: item.id,
            quantity: parseInt(item.quantity)
        }));

        const contentIds = Array.isArray(ev.custom_data?.content_ids)
            ? ev.custom_data.content_ids
            : Object.keys(ev.custom_data?.content_ids || {});

        this.options.tiktok.forEach(ttData => {
            if (!ttData.id) return;

            ttq.instance(ttData.id).track('InitiateCheckout', {
                value: parseFloat(ev.custom_data?.value),
                currency: ev.custom_data?.currency,

                content_ids: contentIds,          // ✅ array
                content_type: ev.custom_data?.content_type,
                contents: contents,

                event_id: (ttData.id + '-' + ev.event_id).trim()
            });
        });
    }


    FireTikTokViewContent(ev) {

        if (!window.ttq || !this.options.tiktok) return;

        // normalize contents
        const contents = (ev.custom_data?.contents || []).map(item => ({
            content_id: item.id,
            quantity: item.quantity
        }));

        this.options.tiktok.forEach(ttData => {
            if (!ttData.id) return;

            ttq.instance(ttData.id).track('ViewContent', {
                value: parseFloat(ev.custom_data?.value),
                currency: ev.custom_data?.currency,

                content_ids: ev.custom_data?.content_ids,
                content_type: ev.custom_data?.content_type,
                contents: contents,

                event_id: (ttData.id + '-' + ev.event_id).trim()
            });
        });


    }


    PageViewGoogleEventFire(event) {

        window.dataLayer = window.dataLayer || [];

        window.dataLayer.push({
            event: 'page_view', // GTM trigger name
            page_title: document.title,
            page_location: window.location.href,
            page_path: window.location.pathname,
            event_id: event.event_id || null
        });
    }
    ViewContentGoogleEventFire(ev) {

        window.dataLayer = window.dataLayer || [];

        const items = ev.custom_data?.contents?.map(item => ({
            item_id: item.id,
            quantity: item.quantity
        })) || [];

        dataLayer.push({
            event: 'view_item',
            event_id: ev.event_id,
            currency: ev.custom_data?.currency,
            value: parseFloat(ev.custom_data?.value),
            items: items,
            page_location: ev.event_source_url
        });
    }
    FireGoogleAddToCart(payload) {

        window.dataLayer = window.dataLayer || [];

        const items = payload.custom_data?.contents?.map(item => ({
            item_id: item.id,
            quantity: item.quantity
        })) || [];

        dataLayer.push({
            event: 'add_to_cart',
            event_id: payload.event_id,

            currency: payload.custom_data?.currency,
            value: parseFloat(payload.custom_data?.value),

            items: items,
            page_location: payload.event_source_url
        });
    }


    FireGoogleBeginCheckout(payload) {

        window.dataLayer = window.dataLayer || [];

        const items = Object.values(payload.custom_data?.contents || {}).map(item => ({
            item_id: item.id,
            quantity: parseInt(item.quantity)
        }));

        dataLayer.push({
            event: 'begin_checkout',
            event_id: payload.event_id,

            currency: payload.custom_data?.currency,
            value: parseFloat(payload.custom_data?.value),

            items: items,
            page_location: payload.event_source_url
        });
    }
    FireGooglePurchase(payload) {

        window.dataLayer = window.dataLayer || [];

        const items = payload.custom_data?.contents?.map(item => ({
            item_id: item.id,
            quantity: item.quantity
        })) || [];

        dataLayer.push({
            event: 'purchase',
            event_id: payload.event_id,

            currency: payload.custom_data?.currency,
            value: parseFloat(payload.custom_data?.value),

            items: items,
            page_location: payload.event_source_url
        });
    }





    bindScrollLinks() {
        $('a[href^="#"]').on('click', function (e) {
            e.preventDefault();
            const targetId = $(this).attr('href');


            if (targetId === '#' || targetId.trim() === '') {
                return;
            }

            const targetElement = $(targetId).get(0);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth' });
            }
        });
    }

    cartOutsideClickListener() {
        const cartWidgetSide = document.querySelector(".cart-widget-side");
        if (cartWidgetSide) {
            cartWidgetSide.addEventListener("click", function (e) {

                if (!e.target.closest(".cart-widget-wrapper") ||
                    e.target.closest(".close-side-widget")) {
                    e.preventDefault();
                    cartWidgetSide.classList.remove("cart-widget-opened");
                }
            });
        }
    }
    MiniCart() {
        $.ajax({
            url: `${base_url}checkout?api=api`,
            method: "GET",
            dataType: "json",
            success: (data) => {
                if (data && data['checkout']) {
                    let itemCount = 0;

                    Object.values(data['checkout']).forEach(group => {
                        if (Array.isArray(group)) {
                            itemCount += group.length;
                        } else if (typeof group === 'object' && group !== null) {
                            itemCount += Object.keys(group).length;
                        }
                    });

                    if (itemCount > 0) {
                        $(".col-minichart .counter-number").html(itemCount).css("display", "block");
                    } else {
                        $(".col-minichart .counter-number").css("display", "none");
                    }
                }
            },
            error: (error) => {
                console.error("MiniCart AJAX error:", error);
            },
        });
    }

    AddToCart() {
        const self = this; // ✅ keep class context
        $(document).on("click", ".btn-add-shopping-cart", function (event) {
            event.preventDefault();

            const button = $(this);
            const product_id = button.attr("product_id");
            const OxiOCartFlows = $("#oxygen-product-cartflows");
            const product_page_id = $("#product_id").val();
            const buttontype = button.attr("data-type") == 'add-to-cut' ? false : true;

            if (buttontype && OxiOCartFlows.length && product_page_id === product_id) {
                const topPosition = OxiOCartFlows.offset().top;
                $("html, body").animate({ scrollTop: topPosition - 20 }, "smooth");
                return;
            } else if (button.hasClass('active')) {
                window.location.href = `${base_url}checkout`;
            } else {
                let quantity = 1;
                let variations = '';
                let customFieldOne = [];

                if (product_page_id === product_id) {

                    quantity = $("#quantity").length ? $("#quantity").val() : 1;
                    let $variationInputs = $('[name="select-variations"], [name="select-variations[]"]');

                    if (!self.validateRequiredFields()) return;

                    variations = $variationInputs.filter(':checked').map(function () {
                        return $(this).val();
                    }).get().join(',');


                    let $fieldWrapper = $('.product-custom-field-one');
                    if ($fieldWrapper.length) {
                        let $select = $fieldWrapper.find('select[name="select-custom-field-one[]"]');
                        if ($select.length) {
                            let selected = $select.val();
                            customFieldOne = Array.isArray(selected) ? selected : (selected !== null ? [selected] : []);
                        } else {
                            $fieldWrapper.find('input[name="select-custom-field-one[]"]:checked').each(function () {
                                customFieldOne.push($(this).val());
                            });
                        }
                    }

                }

                const buttonWidth = button.outerWidth();
                const buttonHeight = button.outerHeight();
                button.css({ width: buttonWidth + "px", height: buttonHeight + "px" }).html('<span class="svg-spinners--bars-scale-middle"></span>');

                $.ajax({
                    url: `${base_url}checkout?api=api&product_id=${product_id}&quantity=${quantity}&variations=${variations}&select-custom-field-one=${customFieldOne}&event=add_to_cut&event_source_url=${window.location.origin + window.location.pathname}`,
                    method: "GET",
                    success: (data) => {
                        try {
                            const jsonData = typeof data === "string" ? JSON.parse(data) : data;

                            if (jsonData && typeof jsonData === "object") {
                                let valu = 0;
                                $.each(jsonData['checkout'], (key, value) => {
                                    if (Array.isArray(value)) valu += value.length;
                                    else if (typeof value === 'object' && value !== null) valu += Object.keys(value).length;
                                });

                                $(`.btn-add-shopping-cart[product_id="${product_id}"][data-type="add-to-cut"]`).each(function () {
                                    const buttonText = $(this).attr("data-text") || "Added";
                                    $(this).html(buttonText).addClass("active");
                                });

                                if (valu > 0) {
                                    const counterNumber = $(".col-minichart .counter-number");
                                    if (counterNumber.length) {
                                        counterNumber.html(valu).css("display", "block");
                                    }
                                }

                                if (jsonData['event'] !== false) {
                                    OxioSoftCoreInstance.BrowserEventFire(jsonData['event']);
                                }

                                if (OxiOCartFlows.length && product_page_id == product_id) {
                                    const topPosition = OxiOCartFlows.offset().top;
                                    $("html, body").animate({ scrollTop: topPosition - 20 }, "smooth");
                                } else {
                                    if (buttontype) {
                                        window.location.href = `${base_url}checkout`;
                                    } else {
                                        $(document).ready(function () {
                                            $(document).cartWidget(jsonData['checkout']);
                                        });
                                    }
                                }

                                return;
                            }
                        } catch (err) {
                            window.location.href = data;
                        }
                    },
                    error: (error) => {
                        window.location.href = `${base_url}checkout?add=${product_id}&variations=${variations}&select-custom-field-one=${customFieldOne}`;
                    },
                });
            }
        });

    }
    validateRequiredFields() {
        const popupMsg = "Please select variations first";

        // Check variations
        const $variationInputs = $('[name="select-variations"], [name="select-variations[]"]');
        if ($variationInputs.length && $variationInputs.filter(':checked').length === 0) {
            alert(popupMsg);
            $variationInputs.first().focus();
            return false;
        }

        // Helper to validate a wrapper
        const checkWrapper = ($wrap) => {
            if (!$wrap.length) return true;

            // Any <select>?
            const $sel = $wrap.find('select[name]');
            if ($sel.length) {
                const v = $sel.val();
                const empty = Array.isArray(v) ? v.length === 0 : (v === null || String(v).trim() === "");
                if (empty) {
                    alert(popupMsg);
                    $sel.first().focus();
                    $('html, body').animate({ scrollTop: $wrap.offset().top - 60 }, 200);
                    return false;
                }
                return true;
            }

            // Any radio/checkbox?
            const $inputs = $wrap.find('input[name]');
            if ($inputs.length && !$inputs.is(':checked')) {
                alert(popupMsg);
                $inputs.first().focus();
                $('html, body').animate({ scrollTop: $wrap.offset().top - 60 }, 200);
                return false;
            }

            return true;
        };

        if (!checkWrapper($('.product-custom-field-one'))) return false;

        return true; // all good
    }

    failOrders() {
        const $form = $('#checkout_form');
        const $phone = $('#billing_phone');

        if (!$form.length || !$phone.length) {
            console.warn('Checkout form or #billing_phone not found.');
            return;
        }

        // Trackers outside the handler so they persist across events
        let debounceTimeout = null;
        let activeRequest = null;
        let lastPayload = null; // prevent sending identical payload repeatedly

        // Bind with a namespace so we can rebind safely
        $('#billing_first_name, #billing_phone, #district, #billing_address_1, #note')
            .off('.failOrders')
            .on('keyup.failOrders blur.failOrders change.failOrders', function () {
                clearTimeout(debounceTimeout);

                // Accept only when phone has at least 11 digits (numbers only)
                const phoneDigits = ($phone.val() || '').replace(/\D/g, '');
                if (phoneDigits.length < 11) return;

                debounceTimeout = setTimeout(function () {
                    // Abort any ongoing request before starting a new one
                    if (activeRequest && activeRequest.readyState !== 4) {
                        activeRequest.abort();
                    }

                    const formData = $form.serialize();

                    // Skip if nothing changed since last send
                    if (formData === lastPayload) return;
                    lastPayload = formData;

                    activeRequest = $.ajax({
                        url: `${base_url}checkout/failed`,
                        type: 'POST',
                        data: formData,
                        success: function (response) {
                            if (response && response.status === 200) {
                                // server returns: { status: 200, data: <id> }
                                window.lastFailedId = response.data;

                            } else {
                                console.warn('Unexpected response:', response);
                            }
                        },
                        error: function (xhr, status, error) {
                            if (status !== 'abort') {
                                console.error('Error updating data:', error);
                            }
                        }
                    });
                }, 1000); // debounce window
            });
    }
}






(function ($) {
    /**
     * A global jQuery function to format numbers without commas.
     * Usage: $(selector).formatNumber(value)
     *
     * @param {number|string} value The number (or string) to format.
     * @return {string} Formatted number.
     */
    $.fn.formatNumber = function (value) {

        if (typeof value === "string") {
            value = parseFloat(value);
        }


        if (isNaN(value)) {
            console.error("Input value must be a valid number");
            return '';
        }

        /**  Check if the value is a whole number (integer or float with no decimal part)
         *
         */
        if (value === Math.floor(value)) {
            return value.toFixed(0);
            /** Return as an integer (no decimals)
             */

        }

        /** Otherwise, return the number with 2 decimal places
         */
        return value.toFixed(2);
    };
})(jQuery);





(function ($) {
    $.fn.stickyHeader = function () {
        var $pageHeader = this;
        var isStickyEnabled = $('meta[name="sticky-header"]').attr("content") === "1";
        /** Check for content="1"
         */

        if (isStickyEnabled && $pageHeader.length) {

            var $parent = $pageHeader.parent();
            var headerHeight = $pageHeader.outerHeight();

            /** Ensure parent is relative and set padding-top
             */
            $parent.css("position", "relative").css("padding-top", headerHeight + "px");
            $pageHeader.css("position", "absolute").css("top", "0");

            $(window).scroll(function () {
                if ($(window).scrollTop() > headerHeight) {
                    $pageHeader.addClass("sticky").css("position", "fixed");
                } else {
                    $pageHeader.removeClass("sticky").css("position", "absolute");
                }
            });
        }
    };

    $(document).ready(function () {
        if ($(".page-header").length) {
            $(".page-header").stickyHeader();
        }
    });
})(jQuery);




const OxioSoftCoreInstance = new OxioSoftCore(EventsSessionOptions);
OxioSoftCoreInstance.init();
window.OxioSoftCore = OxioSoftCoreInstance;



(function () {
    const urlParams = new URLSearchParams(window.location.search);
    const fbclid = urlParams.get("fbclid");
    const utm_source = urlParams.get("utm_source");
    const utm_medium = urlParams.get("utm_medium");
    const utm_campaign = urlParams.get("utm_campaign");
    const utm_content = urlParams.get("utm_content");
    const utm_term = urlParams.get("utm_term");

    const trackingParams = {};

    if (fbclid) {
        trackingParams.fbclid = fbclid;
        localStorage.setItem("fbclid", fbclid);
    } else if (localStorage.getItem("fbclid")) {
        trackingParams.fbclid = localStorage.getItem("fbclid");
    }

    if (utm_source) {
        trackingParams.utm_source = utm_source;
        localStorage.setItem("utm_source", utm_source);
    } else if (localStorage.getItem("utm_source")) {
        trackingParams.utm_source = localStorage.getItem("utm_source");
    }

    if (utm_medium) {
        trackingParams.utm_medium = utm_medium;
        localStorage.setItem("utm_medium", utm_medium);
    } else if (localStorage.getItem("utm_medium")) {
        trackingParams.utm_medium = localStorage.getItem("utm_medium");
    }

    if (utm_campaign) {
        trackingParams.utm_campaign = utm_campaign;
        localStorage.setItem("utm_campaign", utm_campaign);
    } else if (localStorage.getItem("utm_campaign")) {
        trackingParams.utm_campaign = localStorage.getItem("utm_campaign");
    }

    if (utm_content) {
        trackingParams.utm_content = utm_content;
        localStorage.setItem("utm_content", utm_content);
    } else if (localStorage.getItem("utm_content")) {
        trackingParams.utm_content = localStorage.getItem("utm_content");
    }

    if (utm_term) {
        trackingParams.utm_term = utm_term;
        localStorage.setItem("utm_term", utm_term);
    } else if (localStorage.getItem("utm_term")) {
        trackingParams.utm_term = localStorage.getItem("utm_term");
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('a[href^="/"], a[href^="' + window.location.origin + '"]').forEach(function (link) {
            let url;
            try {
                url = new URL(link.href);
            } catch {
                return; // skip invalid URLs
            }

            for (const [key, value] of Object.entries(trackingParams)) {
                if (!url.searchParams.has(key)) {
                    url.searchParams.set(key, value);
                }
            }

            link.href = url.toString();
        });
    });
})();
