jQuery(document).ready(function () {
    var $allSelections = $('.add-to-products-data .single-selection');
    var anyChecked = false;

    $allSelections.each(function () {
        if ($(this).is(':checked')) {
            anyChecked = true;
            $(this).closest('.add-to-products-data').addClass('active');
        }
    });

    if ($allSelections.length === 1 && anyChecked === false || isAutoSelect && anyChecked === false) {
        var $firstProductData = $('.add-to-products-data').first();
        var $firstSingleSelection = $firstProductData.find('.single-selection');
        $firstSingleSelection.prop('checked', true);
        $firstProductData.addClass('active');
    }

    var $shipping = $('#shipping_method .shipping_method');
    $shipping.first().prop('checked', true);





    InlineCheckout();

    $(document).on('click', '.products-quantity-table .procuts-up, .products-quantity-table .procuts-less', function (e) {
        e.preventDefault();
        var $input = $(this).siblings('input[type="number"]');
        var qty = parseInt($input.val(), 10);
        qty = $(this).hasClass('procuts-up') ? qty + 1 : Math.max(1, qty - 1);
        $input.val(qty);
        InlineCheckout();
    });

    $(document).on('change', '.shipping_method', function (e) {
        InlineCheckout();
    });



    $('.add-to-products-data').on('click', function (e) {
        if (
            $(e.target).is('.single-selection') ||
            $(e.target).is('.procuts-up') ||
            $(e.target).is('.procuts-less') ||
            $(e.target).is('input[type=\"number\"]')
        ) return;
        var $input = $(this).find('.single-selection');

        if (!isMultiSelect) {
            $('.add-to-products-data').removeClass('active');
            $('.single-selection').prop('checked', false);
        }

        if (isMultiSelect) {
            $input.prop('checked', !$input.prop('checked'));
        } else {
            $input.prop('checked', true);
        }

        $(this).toggleClass('active', $input.prop('checked'));

        $(this).toggleClass('active', $input.prop('checked'));


        InlineCheckout();
    });


    function InlineCheckout() {

        $('.add-to-products-data').each(function () {
            var $this = $(this);

            var $input = $this.find('.quantities');
            var $info = $this.find('.add-to-products-infor');

            var quantities = parseInt($input.val()) || 1;
            var price = parseFloat($info.data('price')) || 0;
            var oldPrice = parseFloat($info.data('old-price')) || 0;

            var currentPrice = price * quantities;
            var oldPriceValue = oldPrice > 0 ? oldPrice * quantities : 0;

            if ($this.find('.products-current-price').length) {
                const formattedPrice = $(document).formatNumber(currentPrice);

                $this.find('.products-current-price')
                    .show()
                    .html(function (_, html) {
                        if (html.includes('products-current-price-text')) {
                            return html.replace(/products-current-price-text/g, formattedPrice);
                        }
                        return html;
                    });
            }
            if (oldPrice > 0 && oldPriceValue > currentPrice) {
                var percentageOff = Math.round(((oldPriceValue - currentPrice) / oldPriceValue) * 100);
                if ($this.find('.products-discount-amount').length) {
                    const formattedDiscount = $(document).formatNumber(percentageOff);
                    $this.find('.products-discount-amount')
                        .show()
                        .html(function (_, html) {
                            if (html.includes('products-discount-amount-text')) {
                                return html.replace(/products-discount-amount-text/g, formattedDiscount);
                            }
                            return html;
                        });
                }
                var amountSaved = Math.round(oldPriceValue - currentPrice);
                if ($this.find('.products-save-amount').length) {
                    const formattedSaved = $(document).formatNumber(amountSaved);

                    $this.find('.products-save-amount')
                        .show()
                        .html(function (_, html) {
                            if (html.includes('products-save-amount-text')) {
                                return html.replace(/products-save-amount-text/g, formattedSaved);
                            }
                            return html;
                        });
                }

                if ($this.find('.products-old-price').length) {

                    const formattedOldPrice = $(document).formatNumber(oldPriceValue);
                    $this.find('.products-old-price')
                        .show()
                        .html(function (_, html) {
                            if (html.includes('products-old-price-text')) {
                                return html.replace(/products-old-price-text/g, formattedOldPrice);
                            }
                            return html;
                        });
                }

            } else {
                $this.find('.products-navs .products-old-price').hide();
                $this.find('.products-navs .products-discount-amount').hide();
                $this.find('.products-save-amount').hide();
            }
        });

        var $checkedInputs = $('.single-selection:checked');

        if ($checkedInputs.length > 0) {
            let totalCurrent = 0;
            let totalOld = 0;
            let totalQty = 0;

            $checkedInputs.each(function () {
                var $parent = $(this).closest('.add-to-products-data');
                var qty = parseInt($parent.find('.quantities').val()) || 1;
                var price = parseFloat($parent.find('.add-to-products-infor').data('price')) || 0;
                var oldPrice = parseFloat($parent.find('.add-to-products-infor').data('old-price')) || 0;

                totalCurrent += price * qty;
                totalOld += oldPrice > 0 ? oldPrice * qty : price * qty;
                totalQty += qty;

                $parent.addClass('active');
            });



            $('#product_quantity').val(totalQty);
            $('.amount .products-current-price').html($(document).formatNumber(totalCurrent) + $('meta[name=currency-symbol]').attr('content'));

            if (totalOld > totalCurrent) {
                $('.amount .products-old-price').show().html($(document).formatNumber(totalOld) + $('meta[name=currency-symbol]').attr('content'));
            } else {
                $('.amount .products-old-price').hide();
            }

            var $opt = $('.shipping_method:checked');


            var charge = parseFloat($opt.data('charge')) || 0;
            var freeQty = parseFloat($opt.data('free_quantity')) || 0;
            var freeAmt = parseFloat($opt.data('free_amount')) || 0;

            if ((freeQty > 0 && totalQty >= freeQty) || (freeAmt > 0 && totalCurrent >= freeAmt)) {
                charge = 0;
            }

            var grandTotal = totalCurrent + charge;
            var grandOldTotal = totalOld + charge;

            if (charge === 0) {
                $('.shipping-cost-amount').text($('.shipping-cost-amount').data('empty'));
                $('.shipping-cost-currency-symbol').hide();
            } else {
                $('.shipping-cost-amount').text($(document).formatNumber(charge));
                $('.shipping-cost-currency-symbol').show();
            }



            const $pay = $('.payment-method-radio:checked');
            var enable_charge = String($pay.data('enable_charge') || '').toLowerCase();
            var charge_type = String($pay.data('charge_type') || 'Flat').toLowerCase();
            var charge_amount = parseFloat($pay.data('charge_amount')) || 0;

            var payment_mode = String($pay.data('payment_mode') || 'Full').toLowerCase();
            var partial_type = String($pay.data('partial_type') || '').toLowerCase();
            var partial_percent = parseFloat($pay.data('partial_percent')) || 0;



            var grand = grandTotal;

            if (enable_charge === 'on' && charge_amount > 0) {
                if (charge_type === 'percentage') {
                    grandTotal += (grandTotal * charge_amount / 100);
                } else {
                    grandTotal += charge_amount;
                }
            }

            if (grand != grandTotal) {
                let charge = grandTotal - grand;

                $pay.closest('.form-check')
                    .find('label span')
                    .text('Charge: ' + $(document).formatNumber(charge));
            }


            var payNow = grandTotal;
            if (payment_mode === 'partial') {
                if (partial_type === 'deliverycharge') {
                    payNow = Math.max(0, shipCharge);
                } else if (partial_type === 'percentage' && partial_percent > 0) {
                    payNow = Math.max(0, (grandTotal * partial_percent / 100));
                }
            }

            $('.products-total-amount .amount .products-current-price').html($(document).formatNumber(grandTotal) + $('meta[name=currency-symbol]').attr('content'));

            if (totalOld > totalCurrent) {
                $('.products-total-amount .amount .products-old-price').show().html($(document).formatNumber(grandOldTotal) + $('meta[name=currency-symbol]').attr('content'));
            } else {
                $('.products-total-amount .amount .products-old-price').hide();
            }
            $('.checkout-btn-value').html($(document).formatNumber(payNow));

            $('#payment_method_total_value').val(payNow);
        }
    }





    let isProcessing = false;

    $(function () {
        const $form = $('#checkout_form');
        const $submitBtn = $('.checkout-btn');


        const ORIGINAL_HTML = $submitBtn.html();


        function setLoading(on) {
            if (on) {
                $submitBtn
                    .prop('disabled', true)
                    .addClass('is-busy')
                    .html('Processing... <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>');
            } else {
                $submitBtn
                    .prop('disabled', false)
                    .removeClass('is-busy')
                    .html(ORIGINAL_HTML);
            }
        }


        function resetLock() {
            isProcessing = false;
            setLoading(false);
        }


        function convertBanglaToEnglish(str) {
            const bangla = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
            const english = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

            return str.replace(/[০-৯]/g, d => english[bangla.indexOf(d)]);
        }


        $form.on('keydown', function (e) {
            if (isProcessing && e.key === 'Enter') e.preventDefault();
        });

        $form.on('submit', function (e) {
            e.preventDefault();

            if (isProcessing) return;
            isProcessing = true;
            setLoading(true);


            let isValid = true;
            let firstInvalidField = null;
            const fields = ['#billing_first_name', '#billing_phone', '#billing_address_1'];

            fields.forEach(function (selector) {
                const $el = $(selector);
                const val = $.trim(String($el.val() ?? ''));
                const invalid = val === '';
                $el.toggleClass('is-invalid', invalid);
                if (invalid && !firstInvalidField) firstInvalidField = $el;
                if (invalid) isValid = false;
            });


            let rawPhone = $('#billing_phone').val() || '';
            rawPhone = convertBanglaToEnglish(rawPhone);
            const phoneDigits = rawPhone.replace(/\D/g, '');

            if (phoneDigits.length < 11) {
                isValid = false;
                const $ph = $('#billing_phone').addClass('is-invalid');
                if (!firstInvalidField) firstInvalidField = $ph;
            } else {
                $('#billing_phone').removeClass('is-invalid');
            }

            if (!isValid) {

                if (firstInvalidField) {
                    $('html, body').animate(
                        { scrollTop: firstInvalidField.offset().top - 100 },
                        500,
                        () => firstInvalidField.trigger('focus')
                    );
                }
                return resetLock();
            }

            if (typeof validateRequiredFields === 'function' && !validateRequiredFields()) {
                return resetLock();
            }

            const formData = new FormData(this);
            $.ajax({
                url: base_url + 'checkout/submit',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                timeout: 20000,
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                }
            })
                .done(function (response) {
                    resetLock();
                    if (response && response.redirect_url) {
                        window.location.href = response.redirect_url;
                    } else {
                        $form.get(0).submit();
                    }
                })
                .fail(function () {
                    resetLock();
                    $form.get(0).submit();
                });
        });
    });


    $('#billing_first_name, #billing_phone, #billing_address_1').on('blur keyup', function () {
        $(this).toggleClass('is-invalid', $.trim($(this).val()) === '');
    });

    let hasSentRequest = false;
    function isElementInViewport($element) {
        const elementTop = $element.offset().top;
        const elementBottom = elementTop + $element.outerHeight();
        const viewportTop = $(window).scrollTop();
        const viewportBottom = viewportTop + $(window).height();
        return elementBottom > viewportTop && elementTop < viewportBottom;
    }

    $(window).on('scroll', function () {
        const $checkoutForm = $('.checkout_form');
        if ($checkoutForm.length > 0 && isElementInViewport($checkoutForm) && !hasSentRequest) {
            hasSentRequest = true;
            const product_id = $('#products').val();
            const quantity = 1;
            const variations = $('.single-selection:checked').val() || $('.single-selection').first().val() || 0;

            $.ajax({
                url: `${base_url}checkout?api=api&inline_checkout=true&product_id=${product_id}&quantity=${quantity}&variations=${variations}&event=begin_checkout&event_source_url=${window.location.origin + window.location.pathname}`,
                method: "GET",
                success: (data) => {
                    const jsonData = typeof data === "string" ? JSON.parse(data) : data;
                    if (jsonData && typeof jsonData === "object" && jsonData['event'] !== false) {
                        OxioSoftCoreInstance.BrowserEventFire(jsonData['event']);
                    }
                },
                error: (error) => {
                    console.error("Error:", error);
                },
            });
        }
    });


    function validateRequiredFields() {
        const popupMsg = "Please select variations first";

        // Check variations
        const $variationInputs = $('[name="variations"], [name="variations[]"]');
        if ($variationInputs.length && $variationInputs.filter(':checked').length === 0) {
            alert(popupMsg);
            $variationInputs.first().focus();
            return false;
        }

        // Helper to validate a wrapper
        const checkWrapper = ($wrap) => {
            if (!$wrap.length) return true;

            // Any <select>?
            const $sel = $wrap.find('select[name]');
            if ($sel.length) {
                const v = $sel.val();
                const empty = Array.isArray(v) ? v.length === 0 : (v === null || String(v).trim() === "");
                if (empty) {
                    alert(popupMsg);
                    $sel.first().focus();
                    $('html, body').animate({ scrollTop: $wrap.offset().top - 60 }, 200);
                    return false;
                }
                return true;
            }

            // Any radio/checkbox?
            const $inputs = $wrap.find('input[name]');
            if ($inputs.length && !$inputs.is(':checked')) {
                alert(popupMsg);
                $inputs.first().focus();
                $('html, body').animate({ scrollTop: $wrap.offset().top - 60 }, 200);
                return false;
            }

            return true;
        };

        if (!checkWrapper($('.product-custom-field-one'))) return false;
        return true; // all good
    }

    function togglePaymentBoxes() {
        const selected = $('input[name="payment_method"]:checked').val();
        $('.payment_box').hide();
        if (selected) {
            $('#payment_box_' + selected).show();
        }
        InlineCheckout();

    }

    togglePaymentBoxes();
    $(document).on('change', 'input[name="payment_method"]', togglePaymentBoxes);
});
